<!DOCTYPE html>
<meta charset="utf-8">
<html>
  <head>
    <link rel="stylesheet" type="text/css" href="lib/bootstrap/css/bootstrap.css"/>
    <script src="lib/d3/d3.v3.min.js"></script>
    <script src="d3sparql.js"></script>
    <script>
      var arrayURIS = new Array(); //Array global para los recursos
      var arrayValores = [];
      var ranks;
      var prefixs = "PREFIX id:   <http://acm.rkbexplorer.com/id/>"+
                      "PREFIX rdf:  <http://www.w3.org/1999/02/22-rdf-syntax-ns#>"+
                      "PREFIX rdfs: <http://www.w3.org/2000/01/rdf-schema#>"+
                      "PREFIX akt:  <http://www.aktors.org/ontology/portal#>"+
                      "PREFIX owl:  <http://www.w3.org/2002/07/owl#>"+
                      "PREFIX akt:  <http://www.aktors.org/ontology/portal#>"+
                      "PREFIX akts: <http://www.aktors.org/ontology/support#>"
   
   //Funcion que se ejecuta con el boton query
    function exec() { 
      var endpoint = d3.select("#endpoint").property("value")
      var sparql = d3.select("#sparql").property("value")
      d3sparql.query(endpoint, sparql, render)
    }

    //Funcion que pasa el json a la Tabla
    function render(json) {
      var config = {
        "selector": "#result"
      }
      d3sparql.htmltable(json, config)
  }

  //Funcion Recomendadora. 
  //Extrae todos los recursos candidatos de una URI.
      function recom(){
        var sparql = prefixs + "SELECT DISTINCT ?cr1URI ?titulo WHERE {"+
                          "?cr1URI ?link <http://acm.rkbexplorer.com/id/100233>."+
                          "?cr1URI akt:has-title  ?titulo."+
                /*           "?cr1URI akt:has-author ?autor."+
                          "?autor akt:full-name ?autorTit."+ 
                          "?cr1URI akt:addresses-generic-area-of-interest ?area"+ */
                          "}"
        var endpoint = d3.select("#endpoint").property("value")
         d3sparql.query(endpoint, sparql,almArr)
  }
  //Funcion que alamacena en un array los candidatos de la anterior funcion.
  //Luego de seleccionarlos se establecen todos los lins directos entre esos dos recursos.
  function  almArr(json){
      var articsArr = json.results.bindings;
      //Almacena en una array todos los URIS
      for(i in articsArr){
        arrayURIS[i] = {URI:articsArr[i].cr1URI.value,
                        titulo:articsArr[i].titulo.value}
      }    
      var sparqlRec; 
      var i;

      //Buscamos todos los links relacionados con ese recurso y los recursos
      //almacenados anteriormente.
      for(i=0 ; i<arrayURIS.length ; i++){ 
        sparqlRec= prefixs + 
                      "SELECT ?links WHERE{"+
                      //"{ <http://acm.rkbexplorer.com/id/100233> ?links " + "<" +arrURI[i] + ">.}"+
                      //"UNION"+
                      "{<"+arrayURIS[i].URI+">" + " ?links <http://acm.rkbexplorer.com/id/100233>.}"+ 
                      "}"
      var endpoint = d3.select("#endpoint").property("value") 
      d3sparql.query(endpoint,sparqlRec,almValues)
     }  
      }

      //En esta función se realiza el cálculo del ranking.
  function almValues(json){
    console.log(json)
    var uris = json.results.bindings;
    arrayValores.push(1/(1+uris.length)); //De acuerdo a la longitud del array se hace el calculo.
                                          // y se lo almacena en un array.
    var obj 
    var arroBJ = []
    if(arrayValores.length == arrayURIS.length){
      for(i in arrayValores){
       obj = {Valor:(Math.round(arrayValores[i]*100))/100, URI:arrayURIS[i]} 
        arroBJ[i] = obj  //Se almacena en un array los objs.
      }
      arroBJ.sort(  //Se ordena de menor a mayor
        function(a, b){        
          return a.Valor - b.Valor        
        }        
        );

        //Solo es para comprobar.
        var text
        for(i in arroBJ){
          text += "<br>" + arroBJ[i].Valor + " ---> " + arroBJ[i].URI.titulo + " --------> " + arroBJ[i].URI.URI;
          }
            document.getElementById("result").innerHTML = text
    }
  }

  function exec_offline() {
      d3.json("cache/interpro/1117-hk.json", render)
    }
    function toggle() {
      d3sparql.toggle()
    }
    </script>
  </head>
  <body>
    <div id="query" style="margin: 10px">
      <h1>d3htmltable</h1>
      <form class="form-inline">
        <label>SPARQL endpoint:</label>
        <div class="input-append">
          <input id="endpoint" class="span5" value="http://acm.rkbexplorer.com/sparql/" type="text">
          <button class="btn" type="button" onclick="exec()">Query</button>
          <button class="btn" type="button" onclick="recom()">Relacionados</button>
          <button class="btn" type="button" onclick="exec_offline()">Use cache</button>
          <button class="btn" type="button" onclick="toggle()"><i id="button" class="icon-chevron-up"></i></button>
        </div>
      </form>
      <textarea id="sparql" class="span9" rows=15>
       
      </textarea>
    </div>
    <div id="result">

    </div>
  </body>
</html>
